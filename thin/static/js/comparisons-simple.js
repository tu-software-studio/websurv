// Generated by CoffeeScript 1.7.1
(function() {
  var clicked_button, csrfSafeMethod, save_entry;

  csrfSafeMethod = function(method) {
    return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method);
  };

  clicked_button = null;

  $(function() {
    var csrftoken;
    $.ajaxSetup({
      crossDomain: false,
      beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type)) {
          return xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      }
    });
    $("button[type='submit']").click(function(e) {
      var inputs, row;
      clicked_button = $(e.target);
      clicked_button.attr('disabled', 'disabled');
      clicked_button.text("Saving...");
      row = clicked_button.parent().parent();
      inputs = row.find('input');
      return save_entry(row.attr('id'), inputs);
    });
    $("tr input").change(function(e) {
      var $num, button, input, li, num, prev, _i, _len, _ref;
      button = $(e.target).parents('tr').find('button');
      button.text("Save");
      button.removeAttr('disabled');
      input = $(e.target);
      li = input.parent().parent();
      if (parseInt(li.next().find("label input").val()) < parseInt(input.val())) {
        _ref = li.nextAll();
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          num = _ref[_i];
          $num = $(num).find("label input");
          if ($num.val() === input.val()) {
            break;
          }
          $num.val(+$num.val() + 1);
        }
      }
      prev = li.prev().find("label input");
      if (parseInt(prev.val()) > parseInt(input.val())) {
        return input.val(prev.val());
      }
    });
    return csrftoken = $.cookie('csrftoken');
  });

  save_entry = function(trans_id, inputs) {
    var data;
    console.log("saving entry...");
    data = inputs.serialize();
    data += "&trans_id=" + trans_id;
    return $.ajax({
      data: data,
      dataType: "json",
      type: "POST",
      success: function(data, jqXHR) {
        clicked_button.text('Saved');
        clicked_button = null;
        return true;
      },
      error: function(response) {
        var x;
        clicked_button = null;
        console.log("ERROR RESPONSE: " + response.responseText);
        x = JSON.parse(response.responseText);
        $("#messages").append("<div class='alert alert-danger alert-dismissable'><button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>Error!</div>");
        return false;
      }
    });
  };

}).call(this);
